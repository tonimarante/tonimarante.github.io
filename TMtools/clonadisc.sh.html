#!/bin/bash
# Clonadisc. 

# ******************************************************************* 
#!/bin/bash
# Clonadisc. 
VERSIO="v20221208_1157"
# Ajuda en la clonació de discs amb fsarchiver. Fins a 4 particions
# Millor en Debian i derivades

# ----- FUNCS ---------------------------------------
COMPROVA_INSTALL () {
    # Comprova si està instal·lat, si no instal·la
    if ! command -v "$1" &> /dev/null
    then
        apt install "$2"
    fi
}

INFO_PARTIMG () {
    # Mostra info de imatge fsarchiver a recuperar i disc de destinació
    echo "----- INFO DE LA IMATGE fsarchiver GUARDADA ---------------"
    fsarchiver archinfo "$RUTA"/fsarchiver-save.fsa
    echo "***** Enter per a continuar *****"
    read -r HOLA
    echo "----- INFO DEL DISC SOBRE EL QUE RECUPERAREM ---"
    fsarchiver probe
    echo "-----------------------------------"
}

INFO_UUID () {
    # Mostra UUIDS disc original i disc de destinació
    echo "----- UUIDS DELS DISCS ORIGINALS ------------------"
    cat "$RUTA"/uids.txt 
    echo "----- UUIDS DEL DISC SOBRE EL QUE HEM RECUPERAT ---"
    blkid "$DISCNOU"* 
    echo "---------------------------------------------------"
}

DUMP_DISC () {
    ## Guarda info necessària de disc del qual volem fer una imatge
    #
    # Crea directori on guardar els arxius
    echo " "
    echo "________________________________________________________________________________"
    echo "Els fitxers generats es guardaran al directori /home/Clonadisc/"
    echo "***** Introdueix un nom identificatiu del bolcat"
    read -r NOM
    TIMEARA=$(date "+%Y%m%d_%H%M")
    RUTA="/home/Clonadisc/$TIMEARA-Clonadisc-$NOM"
    mkdir -p "$RUTA"
    chmod -Rv 777 /home/Clonadisc
    echo "Clonadisc $VERSIO" > "$RUTA"/clonadisc.txt
    # Em copio a mi mateix per a facilitar la recuperació
    cp "$0" "$RUTA"/
    echo "________________________________________________________________________________"
    echo "***** Pulsa ENTER per a fer un dmesg i veure si has punxat un disc fa poc"
    read -r HOLA
    dmesg | tail -n 100
    echo "***** Enter per a continuar *****"
    read -r HOLA
    clear
    echo "____________________________________________________________________________________________"
    echo "***** Pulsa ENTER per a veure particions de tots els discs a aquest sistema, segons parted"
    read -r HOLA
    parted -l "$DISC" > "$RUTA"/parted.txt
    parted -l "$DISC"
    echo "***** Enter per a continuar i veure ara fdisk -l"
    read -r HOLA
    fdisk  -l "$DISC" > "$RUTA"/fdisk.txt
    fdisk  -l "$DISC"
    echo " "
    echo "------ he guardat aquests resultats a parted.txt i fdisk.txt"
    echo " "
    echo "________________________________________________________________________________"
    echo "***** Introdueix nom de disc a clonar (en format /dev/xxxxx)"
    read -r DISC
    echo "$DISC" > "$RUTA"/disc.txt
    hwinfo --disk --only "$DISC" > "$RUTA"/hwinfo.txt
    echo "------ he guardat info del disc a hwinfo.txt"
    fsarchiver probe "$DISC" 2> "$RUTA"/fsarchiver-probe.txt
    fsarchiver probe "$DISC"
    echo "------ he guardat aquest resultat a fsarchiver-probe.txt"
    echo " "
    sfdisk -d "$DISC" > "$RUTA"/sfdisk_save_part_table.txt
    echo "----- he guardat la taula de particions a clonadisc_sfdisk_save_part_table.txt"
    echo "________________________________________________________________________________"
    echo " "
    # El disc te MBR?
    file -s "$DISC" > "$RUTA"/mbr_or_not.txt
    file -s "$DISC"
    MBR=$(file -s "$DISC" | grep -c MBR)
    if [ "$MBR" -gt 0 ]; then
        echo "----- Sembla un disc BIOS/MBR"
        echo "Sembla un disc BIOS/MBR" > "$RUTA"/BIOS.txt
    else
        echo "----- Sembla un disc UEFI"
        echo "Sembla un disc UEFI" > "$RUTA"/UEFI.txt
    fi
    dd if="$DISC" of="$RUTA"/mbr.img count=1 bs=512 
    echo "----- He guardat MBR a mbr.img per si el disc es BIOS"
    sfdisk -d "$DISC" > "$RUTA"/sfdisk_save_part_table.txt
    echo "----- He guardat l'esquema de particions a sfdisk_save_part_table.txt"
    echo "________________________________________________________________________________"
    echo "***** Enter per a continuar *****"
    read -r HOLA
    clear
    echo "----- A continuació recolliré informació per a fsarchiver save -------------"
    fsarchiver probe
    echo "---------- ATENCIÓ, NO ES PODEN GUARDAR PARTICIONS SWAP --------------------"
    ECHO " "
    echo "***** Introdueix la 1a partició a guardar p.e. Tingues en compte que és guardaran en ordre a la imatge fsa"
    read -r PART1
    if [ ! "$PART1" ]; then 
        echo "ERROR, has d'introduir una partició com a mínim. Surto"
        mv "$RUTA" "$RUTA"-parcial-err
        exit 1
    else
        # Necessitarem UID de partició swap per modificar fstab en el nou disc
        blkid "$DISC"* >> "$RUTA"/uids.txt
        FSARC="fsarchiver -v savefs $RUTA/fsarchiver-save.fsa $PART1"
    fi
    echo "***** Introdueix la 2a partició a guardar p.e. (ENTER sense res en cas que no sigui necessari)"
    read -r PART2
    if [ ! "$PART2" ]; then 
        echo "OK. Procedeixo amb fsarchiver"
    else
        echo "Llista UUIDS disc antic" > "$RUTA"/uids.txt
        FSARC="fsarchiver -v savefs $RUTA/fsarchiver-save.fsa $PART1 $PART2"
        # Intro 3a partició 
        echo "***** Introdueix la 3a partició a guardar p.e. (ENTER sense res en cas que no sigui necessari)"
        read -r PART3
        if [ ! "$PART3" ]; then 
            echo "OK. Procedeixo amb fsarchiver"
        else
            FSARC="fsarchiver -v savefs $RUTA/fsarchiver-save.fsa $PART1 $PART2 $PART3"
            echo "***** Introdueix la 4a partició a guardar p.e. (ENTER sense res en cas que no sigui necessari)"
            read -r PART4
            if [ ! "$PART4" ]; then 
                echo "OK. Procedeixo amb fsarchiver"
            else
                FSARC="fsarchiver -v savefs $RUTA/fsarchiver-save.fsa $PART1 $PART2 $PART3 $PART4"
            fi
        fi
    fi
    clear
    echo "________________________________________________________________________________"
    echo "Ara Executaré:    $FSARC" 
    echo "***** Pulsa ENTER per a començar *****"
    read -r HOLA
    $FSARC
    # Genero un archinfo
    echo "fsarchiver archinfo $RUTA/fsarchiver-save.fsa" > "$RUTA"/fsarchiver-archinfo.txt
    fsarchiver archinfo "$RUTA"/fsarchiver-save.fsa 2>> "$RUTA"/fsarchiver-archinfo.txt
    chmod -Rv 777 "$RUTA" 
}

RECOVER_IMAGE () {
    if [ "$1" = "1" ]; then
        # Entro directament a recuperar, directori Clonedisc detectat
        RUTA=$script_path1
    else
        # Vinc de volcatge 
        echo " "
    fi
    echo "----- Ruta de fitxers a recuperar: $RUTA"
    echo " "
    echo "***********************************************************************************"
    echo "Vols començar el procés de recuperació? (s/n)"
    read -r HOLA
    if [ "$HOLA" = "s" ] || [ "$HOLA" = "S" ]; then 
        echo "________________________________________________________________________________"
        echo "Extreu el disc antic i punxa el nou disc a clonar si vens d'un bolcatge."
        echo "Pulsa ENTER per a fer un dmesg i comprovar quin és l'últim disc que has punxat"
        read -r HOLA
        dmesg | tail -n 100 
        echo " "
        echo "________________________________________________________________________________"
        echo "***** Pulsa ENTER per a veure particions de tots els discs a aquest sistema, segons parted"
        read -r HOLA
        parted -l 
        echo "***** ENTER per a continuar i veure ara fdisk -l"
        read -r HOLA
        fdisk  -l 
        echo " "
        echo "________________________________________________________________________________"
        echo "Introdueix el disc de DESTINACIÓ de la recuperació"
        echo "PERILL !!!!!!! assegura't que el disc a recuperar és el correcte"
        read -r DISCNOU
        echo " "
        echo "________________________________________________________________________________"
        echo "Vols recuperar la taula de particions i MBR en el disc nou: $DISCNOU ? (s/n)"
        echo "(això momés serà interessant si el disc es igual o més gran que l'original)"
        read -r HOLA
        if [ "$HOLA" = "s" ] || [ "$HOLA" = "S" ]; then 
            sfdisk "$DISCNOU" < "$RUTA"/sfdisk_save_part_table.txt
            dd if="$RUTA"/mbr.img of="$DISCNOU" count=1 bs=512
            echo "----- Recuperat MBR i esquema de particions a $DISCNOU"
        else
            echo "OK, no recupero particions. Tingues en compte que el disco ha d'estar pre particionat, llavors"
            echo "Pots consultar els fitxers parted.txt i fsarchiver-probe per a veure quines particions has de crear"
        fi
        echo "________________________________________________________________________________"
        echo "***** ENTER per a continuar"
        read -r HOLA
        clear
        echo "----- A continuació recolliré informació per a fsarchiver restfs -------------"
        echo "-----NO ES PODEN RECUPERAR PARTICIONS SWAP, simplement formatarem de nou -----"
        echo "________________________________________________________________________________"
        # Definició de recuperacions 
        INFO_PARTIMG
        echo " "
        echo "RECORDATORI: Has dit amb anterioritat que vols recuperar sobre el disc $DISCNOU"
        echo " "
        echo "***** Introdueix la 1a partició a recuperar"
        read -r PART1
        echo "***** Introdueix ID de fsarchiver a recuperar en $PART1"
        read -r ID1
        if [ ! "$PART1" ] || [ ! "$ID1" ]; then 
            echo "Error, has d'introduir una partició i ID com a mínim. Surto"
            exit 1
        else
            FSARCREST="fsarchiver -v restfs $RUTA/fsarchiver-save.fsa id=$ID1,dest=$PART1"
        fi
        INFO_PARTIMG
        # Intro la 2a partició
        echo "***** Introdueix la 2a partició a recuperar (ENTER sense res en cas que no sigui necessari)"
        read -r PART2
        echo "***** Introdueix ID de fsarchiver a recuperar en $PART2"
        read -r ID2
        if [ ! "$PART2" ] || [ ! "$ID2" ]; then 
            echo "OK. Procedeixo amb fsarchiver"
        else
            FSARCREST="fsarchiver -v restfs $RUTA/fsarchiver-save.fsa id=$ID1,dest=$PART1 id=$ID2,dest=$PART2"
            # Intro 3a partició 
            INFO_PARTIMG
            echo "***** Introdueix la 3a partició a recuperar (ENTER sense res en cas que no sigui necessari)"
            read -r PART3
            echo "***** Introdueix ID de fsarchiver a recuperar en $PART3"
            read -r ID3
            if [ ! "$PART3" ] || [ ! "$ID3" ]; then 
                echo "OK. Procedeixo amb fsarchiver"
            else
                FSARCREST="fsarchiver -v restfs $RUTA/fsarchiver-save.fsa id=$ID1,dest=$PART1 id=$ID2,dest=$PART2 id=$ID3,dest=$PART3"
                # Intro la 4a partició
                INFO_PARTIMG
                echo "***** Introdueix la 4a partició a recuperar (ENTER sense res en cas que no sigui necessari)"
                read -r PART4
                echo "***** Introdueix ID de fsarchiver a recuperar en $PART4"
                read -r ID4
                if [ ! "$PART4" ] || [ ! "$ID4" ]; then 
                    echo "OK. Procedeixo amb fsarchiver"
                else
                    FSARCREST="fsarchiver -v restfs $RUTA/fsarchiver-save.fsa id=$ID1,dest=$PART1 id=$ID2,dest=$PART2 id=$ID3,dest=$PART3 id=$ID4,dest=$PART4"
                fi
            fi
        fi
        echo "------------------------------------------------------------------------------------------------"
        INFO_PARTIMG
        echo "Ara executaré:    $FSARCREST" 
        echo "***** Pulsa ENTER per a començar"
        read -r HOLA
        $FSARCREST
        echo "------------------------------------------------------------------------------------------------"
        echo "***** Particions restaurades. Pulsa ENTER per a continuar"
        read -r HOLA
        # Bucle infinit, modificació PARTUUIDs si pertoca
        while true
        do
            clear
            echo "      ------------ Comprovació i assignació de UUID a particions -------"
            echo "------------------------------------------------------------------------------------------------"
            INFO_UUID
            echo "Aquí pots comprovar UUIDs de les particions"
            echo "NOTA 1: tenir dues particions amb el mateix UUID al mateix sistema por provocar problemes"
            echo "NOTA 2: recorda que pots generar un nou UUID ateatori amb: uuigen"
            echo "                   - - - - - - - - - - - - - "
            echo "Introdueix la partició en la que he de modificar la UUID (ENTER en blanc per sortir)"
            read -r PARTUUID
            if [ ! "$PARTUUID" ]; then 
                break
            fi
            echo "Introdueix UUID a aplicar a la partició $PARTUUID"
            read -r UUID
            if [ ! "$UUID" ]; then 
                break
            fi
            echo "***** Es tracta d'una partició de swap (s/n)"
            read -r HOLA
            if [ "$HOLA" = "s" ] || [ "$HOLA" = "S" ]; then 
                mkswap "$PARTUUID" -U "$UUID"
            else
                tune2fs "$PARTUUID" -U "$UUID"
            fi
        done
        # End
        clear
        echo "--------  Recuperació de disc, feta. Moltes gràcies per utilitzar Clonadisc. ----------------"
        echo " "
        echo " Si tenim problemes per arrencar el disc nou:"
        echo "     · Comprova en el fitxer /etc/fstab que tot estigui correcte."
        echo "          Ull amb els UUIDs i noms de particions"
        echo "     · Comprova si la partició a arrencar te setejat l'atribut de boot"
        echo "     · Podria fer falta reinstal·lar grub. Una bona opció es arrencar amb supergrub"
        echo "          https://www.supergrubdisk.org i fer un update-grub + grub install"
        echo "---------------------------------------------------------------------------------------------"
    else
        echo "OK, surto. Gràcies per utilitzar Clonadisc!"
        exit 0
    fi
}

# ---------------------------------------------------
# ---------------------------------------------------
# MAIN
apt update
clear
echo "Si tens wget t'he baixat útima versió de https://tonimarante.github.io/TMtools/clonadisc.sh.html"
echo "  Recorda treure el .html final i fer el fitxer executable per a utilitzar la nova versió."
echo " "
echo "***** Pulsa ENTER per a continuar"
read -r HOLA
clear
echo "============= Clonadisc $VERSIO ================================="
echo " "
echo -e "Esteu treballant amb: $(lsb_release -d -s -c)"
# make sure we're running as root   
IDUSER=$(id -u)
if 
    #(( $IDUSER != 0 )); 
    # $/${} is unnecessary on arithmetic variables. Millor:
    (( IDUSER != 0 )); 
then 
    echo "ERROR, has de ser root per a poder executar això. Sortint..."
    exit     
fi

# Requires fsarchiver, parted, sfdisk (fdisk), tun2fs (e2fsprogs), blkid (util-linux)... "
echo " ----- comprovació de dependències i possible instal·lació de paquets (Debian i derivades)"
# apt update (ja ho he fet abans)
COMPROVA_INSTALL "fsarchiver" "fsarchiver"
COMPROVA_INSTALL "parted" "parted"
COMPROVA_INSTALL "sfdisk" "fdisk"
COMPROVA_INSTALL "tune2fs" "e2fsprogs"
COMPROVA_INSTALL "blkid" "util-linux"
COMPROVA_INSTALL "uuidgen" "uuid-runtime"
COMPROVA_INSTALL "hwinfo" "hwinfo"

# Comprovo si estic a directori Clonadisc per si només volem recuperar
# Busco al mateix path a on estic un fitxer com jo, però acabat en .txt
script_name1=$(basename -s .sh "$0")
script_path1=$(dirname "$(readlink -f "$0")")
script_path_with_name="$script_path1/$script_name1"
#echo "Executant aquest script: $script_path_with_name"

# Estic a un directori Clonadisc? 
if [ -f "$script_path_with_name.txt" ]; then
        clear
        echo "He detectat que estic a un directori Clonadisc i per tant interpreto"
        echo "que només volem recuperar aquest volcatge a un disc nou."
        echo " "
        echo "***** Prem Enter per a començar la recuperació"
        read -r HOLA
        RECOVER_IMAGE 1        
else
        DUMP_DISC
        RECOVER_IMAGE 0
fi
exit 0 

# * * * * * * * * * * * * * * * * * *
